<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>かいとくん しりとり</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #FFF0F5; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #header { height: 10%; color: #FF69B4; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; justify-content: center; padding-top: 5px; }
        #aiArea { height: 32%; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px dashed #FFB6C1; border-radius: 15px; background: white; margin: 0 10px; position: relative; }
        #aiWord { font-size: 3.5rem; font-weight: bold; color: #FF4500; }
        #userArea { height: 12%; font-size: 2.2rem; font-weight: bold; color: #4169E1; display: flex; align-items: center; justify-content: center; }
        #msgArea { height: 8%; font-size: 1.1rem; color: #D2691E; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        #choices { height: 38%; display: flex; flex-direction: column; gap: 8px; align-items: center; justify-content: flex-start; }
        button.choice { width: 85%; max-width: 300px; padding: 12px; font-size: 1.4rem; border-radius: 50px; border: none; background-color: #FFB6C1; color: white; box-shadow: 0 4px #FF1493; font-weight: bold; }
        /* 間違えた時の赤色、選んだ時の濃いピンク */
        .selected-btn { background-color: #FF1493 !important; transform: translateY(4px); box-shadow: none !important; }
        .error-btn { background-color: #FF6347 !important; box-shadow: none !important; border: 3px solid #B22222 !important; }
        .retry-btn { padding: 12px 25px; font-size: 1.4rem; background: #FFD700; border-radius: 15px; border: none; font-weight: bold; box-shadow: 0 4px #DAA520; }
        #qrContainer { margin-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div id="header">かいとくん しりとり</div>
    <div id="aiArea">
        <div style="font-size:0.7rem;color:#999;">じじAI</div>
        <div id="aiWord">タッチしてね</div>
        <div id="aiRetry"></div>
    </div>
    <div id="userArea"><div id="userWord"></div><div id="userRetry"></div></div>
    
    <div id="msgArea">がめんを おして スタート！
        <div id="qrContainer">
            <div id="qrcode"></div>
        </div>
    </div>
    
    <div id="choices"></div>

    <script>
        const wordsData = [{kana:"いえ"},{kana:"へや"},{kana:"いす"},{kana:"つくえ"},{kana:"たんす"},{kana:"ほんだな"},{kana:"べっど"},{kana:"ふとん"},{kana:"まくら"},{kana:"かがみ"},{kana:"かーてん"},{kana:"どあ"},{kana:"まど"},{kana:"ゆか"},{kana:"てんじょう"},{kana:"れいぞうこ"},{kana:"でんしれんじ"},{kana:"がすこんろ"},{kana:"なべ"},{kana:"ふらいぱん"},{kana:"おたま"},{kana:"さら"},{kana:"こっぷ"},{kana:"はし"},{kana:"すぷーん"},{kana:"ふぉーく"},{kana:"まないた"},{kana:"ほうちょう"},{kana:"すいどう"},{kana:"しんく"},{kana:"ごはん"},{kana:"ぱん"},{kana:"みず"},{kana:"ぎゅうにゅう"},{kana:"じゅーす"},{kana:"りんご"},{kana:"ばなな"},{kana:"みかん"},{kana:"いちご"},{kana:"たまご"},{kana:"にく"},{kana:"さかな"},{kana:"やさい"},{kana:"すーぷ"},{kana:"おやつ"},{kana:"おふろ"},{kana:"ゆぶね"},{kana:"しゃわー"},{kana:"せっけん"},{kana:"しゃんぷー"},{kana:"りんす"},{kana:"たおる"},{kana:"はぶらし"},{kana:"はみがき"},{kana:"せんめんだい"},{kana:"どらいやー"},{kana:"といれ"},{kana:"べんざ"},{kana:"といれっとぺーぱー"},{kana:"ながし"},{kana:"ふた"},{kana:"ふく"},{kana:"しゃつ"},{kana:"ずぼん"},{kana:"すかーと"},{kana:"くつ"},{kana:"くつした"},{kana:"ぼうし"},{kana:"こーと"},{kana:"ぱじゃま"},{kana:"したぎ"},{kana:"せーたー"},{kana:"てれび"},{kana:"えあこん"},{kana:"せんぷうき"},{kana:"でんき"},{kana:"らいと"},{kana:"すいっち"},{kana:"りもこん"},{kana:"でんわ"},{kana:"すまほ"},{kana:"たぶれっと"},{kana:"ぱそこん"},{kana:"おもちゃ"},{kana:"つみき"},{kana:"ぶろっく"},{kana:"ぬいぐるみ"},{kana:"ぼーる"},{kana:"くるま"},{kana:"でんしゃ"},{kana:"ひこうき"},{kana:"ろぼっと"},{kana:"どーる"},{kana:"えほん"},{kana:"かーど"},{kana:"ぱずる"},{kana:"えんぴつ"},{kana:"くれよん"},{kana:"ぺん"},{kana:"けしごむ"},{kana:"のーと"},{kana:"ほん"},{kana:"かみ"},{kana:"はさみ"},{kana:"せろてーぷ"},{kana:"かばん"},{kana:"りゅっく"},{kana:"さいふ"},{kana:"かぎ"},{kana:"とけい"},{kana:"めがね"},{kana:"はこ"},{kana:"ぶくろ"},{kana:"てぃっしゅ"},{kana:"ごみばこ"},{kana:"そうじき"},{kana:"ほうき"},{kana:"ちりとり"},{kana:"まま"},{kana:"ぱぱ"},{kana:"あかちゃん"},{kana:"おにいちゃん"},{kana:"おねえちゃん"},{kana:"おばあちゃん"},{kana:"おじいちゃん"},{kana:"あたま"},{kana:"かお"},{kana:"め"},{kana:"はな"},{kana:"くち"},{kana:"みみ"},{kana:"て"},{kana:"ゆび"},{kana:"あし"},{kana:"おなか"},{kana:"ねんね"},{kana:"おでかけ"},{kana:"かえり"},{kana:"じゅんび"},{kana:"かれんだー"},{kana:"しゃしん"},{kana:"え"},{kana:"かざり"},{kana:"ぽすたー"},{kana:"てーぶる"},{kana:"らぐ"},{kana:"いぬ"},{kana:"ねこ"},{kana:"かめ"},{kana:"と"},{kana:"おと"},{kana:"こえ"},{kana:"うた"},{kana:"おんがく"},{kana:"げんかん"},{kana:"くつばこ"},{kana:"だいどころ"},{kana:"りびんぐ"},{kana:"しんしつ"},{kana:"ひきだし"},{kana:"たな"},{kana:"かーぺっと"},{kana:"まっと"}];

        let voiceEnabled = false;
        let usedWords = [];

        // 初期表示でQRを表示
        try { new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 80, height: 80 }); } catch(e) {}

        document.body.onclick = () => {
            if(!voiceEnabled) { 
                voiceEnabled = true; 
                document.getElementById('qrContainer').style.display = 'none'; // ゲーム開始でQRを消す
                speak("しりとりしよう！"); 
                handleStart(); 
            }
        };

        function getNextChar(kana) {
            let last = kana.slice(-1);
            if (last === "ー" && kana.length > 1) last = kana.slice(-2, -1);
            return last;
        }

        function handleStart() {
            usedWords = [];
            document.getElementById('aiRetry').innerHTML = "";
            document.getElementById('userRetry').innerHTML = "";
            document.getElementById('userWord').innerText = "";
            document.getElementById('aiWord').innerText = "";
            document.getElementById('aiWord').style.color = "#FF4500";
            document.getElementById('msgArea').innerText = "どれにする？";
            
            const starts = wordsData.filter(w => !w.kana.endsWith("ん"));
            const first = starts[Math.floor(Math.random() * starts.length)];
            usedWords.push(first.kana);
            aiTurn(first);
        }

        function aiTurn(word) {
            // AIの番になったら、ユーザーエリアの文字を消す（3.のご指示）
            document.getElementById('userWord').innerText = ""; 
            
            const el = document.getElementById('aiWord');
            el.innerText = word.kana;
            speak(word.kana);
            
            const head = getNextChar(word.kana);
            const choices = createChoices(head);
            renderButtons(choices, head);
        }

        function createChoices(head) {
            let avail = wordsData.filter(w => !usedWords.includes(w.kana));
            let ok = avail.filter(w => w.kana.startsWith(head));
            let ng = avail.filter(w => !w.kana.startsWith(head));
            if (ok.length === 0) return [];
            let list = [];
            ok.sort(() => Math.random() - 0.5).slice(0, 2).forEach(w => list.push(w));
            ng.sort(() => Math.random() - 0.5).slice(0, 3 - list.length).forEach(w => list.push(w));
            return list.sort(() => Math.random() - 0.5);
        }

        function renderButtons(list, head) {
            const area = document.getElementById('choices');
            area.innerHTML = '';
            
            if (list.length === 0) {
                setTimeout(() => endGame("カード切れちゃった", "user", document.getElementById('aiWord').innerText), 500);
                return;
            }

            list.forEach(w => {
                const b = document.createElement('button');
                b.className = 'choice';
                b.innerText = w.kana;
                b.onclick = function(e) { 
                    e.stopPropagation(); 
                    userSelect(this, w, head); 
                };
                area.appendChild(b);
            });
        }

        function userSelect(btnElement, word, head) {
            // 4. 間違い入力時の対応
            if(!word.kana.startsWith(head)) {
                btnElement.classList.add('error-btn'); // ボタンを赤くして保持
                speak("ちがうよ、えらびなおしてね");
                document.getElementById('msgArea').innerText = "ちがうよ、えらびなおしてね";
                // 1.5秒後にメッセージだけ戻すが、ボタンの赤色はそのままにしておく
                setTimeout(() => { 
                    document.getElementById('msgArea').innerText = "どれにする？"; 
                }, 1500);
                return;
            }
            
            // 正解の場合
            document.querySelectorAll('.choice').forEach(b => b.classList.remove('selected-btn', 'error-btn'));
            btnElement.classList.add('selected-btn');
            
            usedWords.push(word.kana);
            const el = document.getElementById('userWord');
            el.innerText = word.kana;
            speak(word.kana);

            if(word.kana.endsWith("ん")) {
                setTimeout(() => endGame("「ん」ついたよ。", "ai", word.kana), 800);
                return;
            }

            document.getElementById('msgArea').innerText = "じじAIが かんがえちゅう...";
            setTimeout(() => {
                const nextHead = getNextChar(word.kana);
                let matches = wordsData.filter(w => w.kana.startsWith(nextHead) && !usedWords.includes(w.kana));
                
                if(matches.length === 0) {
                    endGame("きみの勝ち", "user", word.kana);
                } else {
                    document.getElementById('msgArea').innerText = "どれにする？";
                    const aiWord = matches.find(w => !w.kana.endsWith("ん")) || matches[0];
                    usedWords.push(aiWord.kana);
                    aiTurn(aiWord);
                    if(aiWord.kana.endsWith("ん")) {
                        setTimeout(() => endGame("きみの勝ち", "user", aiWord.kana), 1000);
                    }
                }
            }, 1500);
        }

        function endGame(msg, loser, lastWord) {
            document.getElementById('msgArea').innerText = msg;
            speak(msg);
            const retryBtnHtml = `<button class="retry-btn" onclick="handleStart()">もう一回</button>`;
            
            // 2. 終了画面のロジック
            if(msg === "きみの勝ち") {
                // じじAIが負けた時：じじAIエリアは「カード切れ」等の文字のみ、ユーザー側に「もう一回」
                document.getElementById('aiWord').innerText = "カード切れ";
                document.getElementById('aiWord').style.color = "#999";
                document.getElementById('userWord').innerText = lastWord; // 自分が最後に出した言葉
                document.getElementById('userRetry').innerHTML = retryBtnHtml;
            } else if(msg.includes("ん") || msg.includes("カード切れちゃった")) {
                // ユーザーが負けた時：ユーザー側に「もう一回」
                document.getElementById('aiWord').innerText = lastWord;
                document.getElementById('userWord').innerText = msg.includes("ん") ? "ん がついた" : "カード切れ";
                document.getElementById('userRetry').innerHTML = retryBtnHtml;
            }
            
            // 選択肢ボタンはそのまま残す（無効化のみ）
            document.querySelectorAll('.choice').forEach(b => {
                b.disabled = true;
                if(!b.classList.contains('selected-btn')) b.style.opacity = "0.5";
            });
        }

        function speak(text) {
            if(!voiceEnabled) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
