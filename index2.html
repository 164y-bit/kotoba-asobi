<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‹ã„ã¨ãã‚“ ã—ã‚Šã¨ã‚Š</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #FFF0F5; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #header { height: 10%; color: #FF69B4; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; justify-content: center; padding-top: 5px; }
        #aiArea { height: 32%; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px dashed #FFB6C1; border-radius: 15px; background: white; margin: 0 10px; position: relative; }
        #aiWord { font-size: 3.5rem; font-weight: bold; color: #FF4500; }
        #userArea { height: 12%; font-size: 2.2rem; font-weight: bold; color: #4169E1; display: flex; align-items: center; justify-content: center; }
        #msgArea { height: 8%; font-size: 1.1rem; color: #D2691E; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        #choices { height: 38%; display: flex; flex-direction: column; gap: 8px; align-items: center; justify-content: flex-start; }
        button.choice { width: 85%; max-width: 300px; padding: 12px; font-size: 1.4rem; border-radius: 50px; border: none; background-color: #FFB6C1; color: white; box-shadow: 0 4px #FF1493; font-weight: bold; }
        /* é–“é•ãˆãŸæ™‚ã®èµ¤è‰²ã€é¸ã‚“ã æ™‚ã®æ¿ƒã„ãƒ”ãƒ³ã‚¯ */
        .selected-btn { background-color: #FF1493 !important; transform: translateY(4px); box-shadow: none !important; }
        .error-btn { background-color: #FF6347 !important; box-shadow: none !important; border: 3px solid #B22222 !important; }
        .retry-btn { padding: 12px 25px; font-size: 1.4rem; background: #FFD700; border-radius: 15px; border: none; font-weight: bold; box-shadow: 0 4px #DAA520; }
        #qrContainer { margin-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div id="header">ã‹ã„ã¨ãã‚“ ã—ã‚Šã¨ã‚Š</div>
    <div id="aiArea">
        <div style="font-size:0.7rem;color:#999;">ã˜ã˜AI</div>
        <div id="aiWord">3æ­³ã®èª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ğŸ‚</div>
        <div id="aiRetry"></div>
    </div>
    <div id="userArea"><div id="userWord"></div><div id="userRetry"></div></div>
    
    <div id="msgArea">ãŒã‚ã‚“ã€€ã‚¿ãƒƒãƒã€€ã‚¹ã‚¿ãƒ¼ãƒˆï¼
        <div id="qrContainer">
            <div id="qrcode"></div>
        </div>
    </div>
    
    <div id="choices"></div>

    <script>
        const wordsData = [{kana:"ã„ãˆ"},{kana:"ã¸ã‚„"},{kana:"ã„ã™"},{kana:"ã¤ããˆ"},{kana:"ãŸã‚“ã™"},{kana:"ã»ã‚“ã ãª"},{kana:"ã¹ã£ã©"},{kana:"ãµã¨ã‚“"},{kana:"ã¾ãã‚‰"},{kana:"ã‹ãŒã¿"},{kana:"ã‹ãƒ¼ã¦ã‚“"},{kana:"ã©ã‚"},{kana:"ã¾ã©"},{kana:"ã‚†ã‹"},{kana:"ã¦ã‚“ã˜ã‚‡ã†"},{kana:"ã‚Œã„ãã†ã“"},{kana:"ã§ã‚“ã—ã‚Œã‚“ã˜"},{kana:"ãŒã™ã“ã‚“ã‚"},{kana:"ãªã¹"},{kana:"ãµã‚‰ã„ã±ã‚“"},{kana:"ãŠãŸã¾"},{kana:"ã•ã‚‰"},{kana:"ã“ã£ã·"},{kana:"ã¯ã—"},{kana:"ã™ã·ãƒ¼ã‚“"},{kana:"ãµã‰ãƒ¼ã"},{kana:"ã¾ãªã„ãŸ"},{kana:"ã»ã†ã¡ã‚‡ã†"},{kana:"ã™ã„ã©ã†"},{kana:"ã—ã‚“ã"},{kana:"ã”ã¯ã‚“"},{kana:"ã±ã‚“"},{kana:"ã¿ãš"},{kana:"ãã‚…ã†ã«ã‚…ã†"},{kana:"ã˜ã‚…ãƒ¼ã™"},{kana:"ã‚Šã‚“ã”"},{kana:"ã°ãªãª"},{kana:"ã¿ã‹ã‚“"},{kana:"ã„ã¡ã”"},{kana:"ãŸã¾ã”"},{kana:"ã«ã"},{kana:"ã•ã‹ãª"},{kana:"ã‚„ã•ã„"},{kana:"ã™ãƒ¼ã·"},{kana:"ãŠã‚„ã¤"},{kana:"ãŠãµã‚"},{kana:"ã‚†ã¶ã­"},{kana:"ã—ã‚ƒã‚ãƒ¼"},{kana:"ã›ã£ã‘ã‚“"},{kana:"ã—ã‚ƒã‚“ã·ãƒ¼"},{kana:"ã‚Šã‚“ã™"},{kana:"ãŸãŠã‚‹"},{kana:"ã¯ã¶ã‚‰ã—"},{kana:"ã¯ã¿ãŒã"},{kana:"ã›ã‚“ã‚ã‚“ã ã„"},{kana:"ã©ã‚‰ã„ã‚„ãƒ¼"},{kana:"ã¨ã„ã‚Œ"},{kana:"ã¹ã‚“ã–"},{kana:"ã¨ã„ã‚Œã£ã¨ãºãƒ¼ã±ãƒ¼"},{kana:"ãªãŒã—"},{kana:"ãµãŸ"},{kana:"ãµã"},{kana:"ã—ã‚ƒã¤"},{kana:"ãšã¼ã‚“"},{kana:"ã™ã‹ãƒ¼ã¨"},{kana:"ãã¤"},{kana:"ãã¤ã—ãŸ"},{kana:"ã¼ã†ã—"},{kana:"ã“ãƒ¼ã¨"},{kana:"ã±ã˜ã‚ƒã¾"},{kana:"ã—ãŸã"},{kana:"ã›ãƒ¼ãŸãƒ¼"},{kana:"ã¦ã‚Œã³"},{kana:"ãˆã‚ã“ã‚“"},{kana:"ã›ã‚“ã·ã†ã"},{kana:"ã§ã‚“ã"},{kana:"ã‚‰ã„ã¨"},{kana:"ã™ã„ã£ã¡"},{kana:"ã‚Šã‚‚ã“ã‚“"},{kana:"ã§ã‚“ã‚"},{kana:"ã™ã¾ã»"},{kana:"ãŸã¶ã‚Œã£ã¨"},{kana:"ã±ãã“ã‚“"},{kana:"ãŠã‚‚ã¡ã‚ƒ"},{kana:"ã¤ã¿ã"},{kana:"ã¶ã‚ã£ã"},{kana:"ã¬ã„ãã‚‹ã¿"},{kana:"ã¼ãƒ¼ã‚‹"},{kana:"ãã‚‹ã¾"},{kana:"ã§ã‚“ã—ã‚ƒ"},{kana:"ã²ã“ã†ã"},{kana:"ã‚ã¼ã£ã¨"},{kana:"ã©ãƒ¼ã‚‹"},{kana:"ãˆã»ã‚“"},{kana:"ã‹ãƒ¼ã©"},{kana:"ã±ãšã‚‹"},{kana:"ãˆã‚“ã´ã¤"},{kana:"ãã‚Œã‚ˆã‚“"},{kana:"ãºã‚“"},{kana:"ã‘ã—ã”ã‚€"},{kana:"ã®ãƒ¼ã¨"},{kana:"ã»ã‚“"},{kana:"ã‹ã¿"},{kana:"ã¯ã•ã¿"},{kana:"ã›ã‚ã¦ãƒ¼ã·"},{kana:"ã‹ã°ã‚“"},{kana:"ã‚Šã‚…ã£ã"},{kana:"ã•ã„ãµ"},{kana:"ã‹ã"},{kana:"ã¨ã‘ã„"},{kana:"ã‚ãŒã­"},{kana:"ã¯ã“"},{kana:"ã¶ãã‚"},{kana:"ã¦ãƒã£ã—ã‚…"},{kana:"ã”ã¿ã°ã“"},{kana:"ãã†ã˜ã"},{kana:"ã»ã†ã"},{kana:"ã¡ã‚Šã¨ã‚Š"},{kana:"ã¾ã¾"},{kana:"ã±ã±"},{kana:"ã‚ã‹ã¡ã‚ƒã‚“"},{kana:"ãŠã«ã„ã¡ã‚ƒã‚“"},{kana:"ãŠã­ãˆã¡ã‚ƒã‚“"},{kana:"ãŠã°ã‚ã¡ã‚ƒã‚“"},{kana:"ãŠã˜ã„ã¡ã‚ƒã‚“"},{kana:"ã‚ãŸã¾"},{kana:"ã‹ãŠ"},{kana:"ã‚"},{kana:"ã¯ãª"},{kana:"ãã¡"},{kana:"ã¿ã¿"},{kana:"ã¦"},{kana:"ã‚†ã³"},{kana:"ã‚ã—"},{kana:"ãŠãªã‹"},{kana:"ã­ã‚“ã­"},{kana:"ãŠã§ã‹ã‘"},{kana:"ã‹ãˆã‚Š"},{kana:"ã˜ã‚…ã‚“ã³"},{kana:"ã‹ã‚Œã‚“ã ãƒ¼"},{kana:"ã—ã‚ƒã—ã‚“"},{kana:"ãˆ"},{kana:"ã‹ã–ã‚Š"},{kana:"ã½ã™ãŸãƒ¼"},{kana:"ã¦ãƒ¼ã¶ã‚‹"},{kana:"ã‚‰ã"},{kana:"ã„ã¬"},{kana:"ã­ã“"},{kana:"ã‹ã‚"},{kana:"ã¨"},{kana:"ãŠã¨"},{kana:"ã“ãˆ"},{kana:"ã†ãŸ"},{kana:"ãŠã‚“ãŒã"},{kana:"ã’ã‚“ã‹ã‚“"},{kana:"ãã¤ã°ã“"},{kana:"ã ã„ã©ã“ã‚"},{kana:"ã‚Šã³ã‚“ã"},{kana:"ã—ã‚“ã—ã¤"},{kana:"ã²ãã ã—"},{kana:"ãŸãª"},{kana:"ã‹ãƒ¼ãºã£ã¨"},{kana:"ã¾ã£ã¨"}];

        let voiceEnabled = false;
        let usedWords = [];

        // åˆæœŸè¡¨ç¤ºã§QRã‚’è¡¨ç¤º
        try { new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 80, height: 80 }); } catch(e) {}

        document.body.onclick = () => {
            if(!voiceEnabled) { 
                voiceEnabled = true; 
                document.getElementById('qrContainer').style.display = 'none'; // ã‚²ãƒ¼ãƒ é–‹å§‹ã§QRã‚’æ¶ˆã™
                speak("ã—ã‚Šã¨ã‚Šã—ã‚ˆã†ï¼"); 
                handleStart(); 
            }
        };

        function getNextChar(kana) {
            let last = kana.slice(-1);
            if (last === "ãƒ¼" && kana.length > 1) last = kana.slice(-2, -1);
            return last;
        }

        function handleStart() {
            usedWords = [];
            document.getElementById('aiRetry').innerHTML = "";
            document.getElementById('userRetry').innerHTML = "";
            document.getElementById('userWord').innerText = "";
            document.getElementById('aiWord').innerText = "";
            document.getElementById('aiWord').style.color = "#FF4500";
            document.getElementById('msgArea').innerText = "ã©ã‚Œã«ã™ã‚‹ï¼Ÿ";
            
            const starts = wordsData.filter(w => !w.kana.endsWith("ã‚“"));
            const first = starts[Math.floor(Math.random() * starts.length)];
            usedWords.push(first.kana);
            aiTurn(first);
        }

        function aiTurn(word) {
            // AIã®ç•ªã«ãªã£ãŸã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒªã‚¢ã®æ–‡å­—ã‚’æ¶ˆã™ï¼ˆ3.ã®ã”æŒ‡ç¤ºï¼‰
            document.getElementById('userWord').innerText = ""; 
            
            const el = document.getElementById('aiWord');
            el.innerText = word.kana;
            speak(word.kana);
            
            const head = getNextChar(word.kana);
            const choices = createChoices(head);
            renderButtons(choices, head);
        }

        function createChoices(head) {
            let avail = wordsData.filter(w => !usedWords.includes(w.kana));
            let ok = avail.filter(w => w.kana.startsWith(head));
            let ng = avail.filter(w => !w.kana.startsWith(head));
            if (ok.length === 0) return [];
            let list = [];
            ok.sort(() => Math.random() - 0.5).slice(0, 2).forEach(w => list.push(w));
            ng.sort(() => Math.random() - 0.5).slice(0, 3 - list.length).forEach(w => list.push(w));
            return list.sort(() => Math.random() - 0.5);
        }

        function renderButtons(list, head) {
            const area = document.getElementById('choices');
            area.innerHTML = '';
            
            if (list.length === 0) {
                setTimeout(() => endGame("ã‚«ãƒ¼ãƒ‰åˆ‡ã‚Œã¡ã‚ƒã£ãŸ", "user", document.getElementById('aiWord').innerText), 500);
                return;
            }

            list.forEach(w => {
                const b = document.createElement('button');
                b.className = 'choice';
                b.innerText = w.kana;
                b.onclick = function(e) { 
                    e.stopPropagation(); 
                    userSelect(this, w, head); 
                };
                area.appendChild(b);
            });
        }

        function userSelect(btnElement, word, head) {
            // 4. é–“é•ã„å…¥åŠ›æ™‚ã®å¯¾å¿œ
            if(!word.kana.startsWith(head)) {
                btnElement.classList.add('error-btn'); // ãƒœã‚¿ãƒ³ã‚’èµ¤ãã—ã¦ä¿æŒ
                speak("ã¡ãŒã†ã‚ˆã€ãˆã‚‰ã³ãªãŠã—ã¦ã­");
                document.getElementById('msgArea').innerText = "ã¡ãŒã†ã‚ˆã€ãˆã‚‰ã³ãªãŠã—ã¦ã­";
                // 1.5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘æˆ»ã™ãŒã€ãƒœã‚¿ãƒ³ã®èµ¤è‰²ã¯ãã®ã¾ã¾ã«ã—ã¦ãŠã
                setTimeout(() => { 
                    document.getElementById('msgArea').innerText = "ã©ã‚Œã«ã™ã‚‹ï¼Ÿ"; 
                }, 1500);
                return;
            }
            
            // æ­£è§£ã®å ´åˆ
            document.querySelectorAll('.choice').forEach(b => b.classList.remove('selected-btn', 'error-btn'));
            btnElement.classList.add('selected-btn');
            
            usedWords.push(word.kana);
            const el = document.getElementById('userWord');
            el.innerText = word.kana;
            speak(word.kana);

            if(word.kana.endsWith("ã‚“")) {
                setTimeout(() => endGame("ã€Œã‚“ã€ã¤ã„ãŸã‚ˆã€‚", "ai", word.kana), 800);
                return;
            }

            document.getElementById('msgArea').innerText = "ã˜ã˜AIãŒ ã‹ã‚“ãŒãˆã¡ã‚…ã†...";
            setTimeout(() => {
                const nextHead = getNextChar(word.kana);
                let matches = wordsData.filter(w => w.kana.startsWith(nextHead) && !usedWords.includes(w.kana));
                
                if(matches.length === 0) {
                    endGame("ãã¿ã®å‹ã¡", "user", word.kana);
                } else {
                    document.getElementById('msgArea').innerText = "ã©ã‚Œã«ã™ã‚‹ï¼Ÿ";
                    const aiWord = matches.find(w => !w.kana.endsWith("ã‚“")) || matches[0];
                    usedWords.push(aiWord.kana);
                    aiTurn(aiWord);
                    if(aiWord.kana.endsWith("ã‚“")) {
                        setTimeout(() => endGame("ãã¿ã®å‹ã¡", "user", aiWord.kana), 1000);
                    }
                }
            }, 1500);
        }

        function endGame(msg, loser, lastWord) {
            document.getElementById('msgArea').innerText = msg;
            speak(msg);
            const retryBtnHtml = `<button class="retry-btn" onclick="handleStart()">ã‚‚ã†ä¸€å›</button>`;
            
            // 2. çµ‚äº†ç”»é¢ã®ãƒ­ã‚¸ãƒƒã‚¯
            if(msg === "ãã¿ã®å‹ã¡") {
                // ã˜ã˜AIãŒè² ã‘ãŸæ™‚ï¼šã˜ã˜AIã‚¨ãƒªã‚¢ã¯ã€Œã‚«ãƒ¼ãƒ‰åˆ‡ã‚Œã€ç­‰ã®æ–‡å­—ã®ã¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã«ã€Œã‚‚ã†ä¸€å›ã€
                document.getElementById('aiWord').innerText = "ã‚«ãƒ¼ãƒ‰åˆ‡ã‚Œ";
                document.getElementById('aiWord').style.color = "#999";
                document.getElementById('userWord').innerText = lastWord; // è‡ªåˆ†ãŒæœ€å¾Œã«å‡ºã—ãŸè¨€è‘‰
                document.getElementById('userRetry').innerHTML = retryBtnHtml;
            } else if(msg.includes("ã‚“") || msg.includes("ã‚«ãƒ¼ãƒ‰åˆ‡ã‚Œã¡ã‚ƒã£ãŸ")) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè² ã‘ãŸæ™‚ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã«ã€Œã‚‚ã†ä¸€å›ã€
                document.getElementById('aiWord').innerText = lastWord;
                document.getElementById('userWord').innerText = msg.includes("ã‚“") ? "ã‚“ ãŒã¤ã„ãŸ" : "ã‚«ãƒ¼ãƒ‰åˆ‡ã‚Œ";
                document.getElementById('userRetry').innerHTML = retryBtnHtml;
            }
            
            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã¯ãã®ã¾ã¾æ®‹ã™ï¼ˆç„¡åŠ¹åŒ–ã®ã¿ï¼‰
            document.querySelectorAll('.choice').forEach(b => {
                b.disabled = true;
                if(!b.classList.contains('selected-btn')) b.style.opacity = "0.5";
            });
        }

        function speak(text) {
            if(!voiceEnabled) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
